<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin â€” Near Miss Map</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .lightbox-overlay {
      display: none; position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.85); align-items: center; justify-content: center;
    }
    .lightbox-overlay.active { display: flex; }
    .lightbox-overlay img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
    .lightbox-close {
      position: absolute; top: 16px; right: 16px; color: #fff; font-size: 24px;
      background: rgba(0,0,0,.5); border: none; border-radius: 50%; width: 40px; height: 40px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Navbar -->
  <header class="sticky top-0 z-50 bg-slate-900 shadow-lg" style="font-family: 'DM Sans', sans-serif;">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="flex items-center justify-between h-14">
        <div class="flex items-center gap-x-2.5">
          <div class="size-8 rounded-lg bg-red-500 flex items-center justify-center">
            <i class="fa-solid fa-shield-halved text-white text-sm"></i>
          </div>
          <div class="leading-tight">
            <span class="text-base font-bold text-white">Near Miss Map</span>
            <span class="block text-[10px] text-slate-400 -mt-0.5">Admin Moderation</span>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <a href="./" class="text-xs text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-1"></i>Back to Map</a>
          <span id="user-info" class="text-xs text-slate-300 hidden"></span>
          <button id="sign-out-btn" onclick="signOut()" class="hidden text-xs text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-right-from-bracket mr-1"></i>Sign Out</button>
        </div>
      </div>
    </nav>
  </header>

  <!-- Login Gate -->
  <div id="login-gate" class="hidden flex flex-col items-center justify-center min-h-[80vh] px-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
      <div class="text-center mb-6">
        <div class="size-16 rounded-2xl bg-slate-900 flex items-center justify-center mx-auto mb-4">
          <i class="fa-solid fa-shield-halved text-white text-2xl"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-900">Admin Sign In</h2>
        <p class="text-sm text-gray-500 mt-1">Sign in with your admin account</p>
      </div>
      <div class="space-y-3">
        <button onclick="signInWithApple()" class="w-full py-3 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg bg-gray-800 text-white hover:bg-gray-900 transition-colors">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
          Continue with Apple
        </button>
        <button onclick="signInWithGoogle()" class="w-full py-3 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 transition-colors">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continue with Google
        </button>
        <div class="py-3 flex items-center text-xs text-gray-400 uppercase before:flex-1 before:border-t before:border-gray-200 before:me-6 after:flex-1 after:border-t after:border-gray-200 after:ms-6">or</div>
        <div id="email-form" class="space-y-3">
          <input type="email" id="login-email" placeholder="Email address" class="py-3 px-4 block w-full border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500">
          <input type="password" id="login-password" placeholder="Password" class="py-3 px-4 block w-full border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500">
          <button onclick="signInWithEmail()" class="w-full py-3 px-4 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">Sign In</button>
        </div>
        <p id="login-error" class="text-red-500 text-sm text-center"></p>
      </div>
    </div>
  </div>

  <!-- Access Denied -->
  <div id="access-denied" class="hidden flex flex-col items-center justify-center min-h-[80vh] px-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
      <div class="size-16 rounded-2xl bg-red-100 flex items-center justify-center mx-auto mb-4">
        <i class="fa-solid fa-ban text-red-500 text-2xl"></i>
      </div>
      <h2 class="text-xl font-bold text-gray-900">Access Denied</h2>
      <p class="text-sm text-gray-500 mt-2">You don't have admin or moderator privileges.</p>
      <div class="mt-6 flex gap-3 justify-center">
        <a href="./" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-900 text-white hover:bg-slate-800 transition-colors">Back to Map</a>
        <button onclick="signOut()" class="px-4 py-2 text-sm font-medium rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors">Sign Out</button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading-state" class="hidden flex flex-col items-center justify-center min-h-[80vh]">
    <i class="fa-solid fa-spinner fa-spin text-3xl text-slate-400 mb-4"></i>
    <p class="text-sm text-slate-500">Checking permissions...</p>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">

      <!-- Stats bar -->
      <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-6">
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
          <div class="text-2xl font-bold text-gray-900" id="stat-total">-</div>
          <div class="text-xs text-gray-500">Total Reports</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-red-100">
          <div class="text-2xl font-bold text-red-600" id="stat-flagged">-</div>
          <div class="text-xs text-gray-500">Flagged</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-amber-100">
          <div class="text-2xl font-bold text-amber-600" id="stat-pending">-</div>
          <div class="text-xs text-gray-500">Pending Verification</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-green-100">
          <div class="text-2xl font-bold text-green-600" id="stat-approved">-</div>
          <div class="text-xs text-gray-500">Approved</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-blue-100">
          <div class="text-2xl font-bold text-blue-600" id="stat-subscribers-card">-</div>
          <div class="text-xs text-gray-500"><i class="fa-solid fa-envelope mr-1"></i>Subscribers</div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-4">
        <div class="p-4 flex flex-col sm:flex-row items-start sm:items-center gap-3">
          <!-- Filter tabs -->
          <div class="flex gap-1 bg-gray-100 rounded-lg p-1">
            <button onclick="setFilter('all')" data-filter="all" class="filter-tab px-3 py-1.5 text-xs font-medium rounded-md transition-colors bg-white shadow-sm text-gray-900">All</button>
            <button onclick="setFilter('flagged')" data-filter="flagged" class="filter-tab px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-gray-500 hover:text-gray-700">Flagged</button>
            <button onclick="setFilter('pending')" data-filter="pending" class="filter-tab px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-gray-500 hover:text-gray-700">Pending</button>
            <button onclick="setFilter('approved')" data-filter="approved" class="filter-tab px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-gray-500 hover:text-gray-700">Approved</button>
          </div>
          <!-- Search -->
          <div class="flex-1 w-full sm:w-auto">
            <div class="relative">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
              <input type="text" id="search-input" placeholder="Search description, location, reporter..." oninput="applyFilters()" class="w-full pl-9 pr-4 py-2 text-sm border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none">
            </div>
          </div>
          <!-- Collection filter -->
          <select id="collection-filter" onchange="applyFilters()" class="text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-blue-500">
            <option value="all">All Types</option>
            <option value="incidents">Incidents Only</option>
            <option value="annoyances">Annoyances Only</option>
          </select>
        </div>
      </div>

      <!-- Table -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
              <tr>
                <th class="px-4 py-3 w-8"></th>
                <th class="px-4 py-3">Type</th>
                <th class="px-4 py-3">Location</th>
                <th class="px-4 py-3 min-w-[200px]">Description</th>
                <th class="px-4 py-3">Reporter</th>
                <th class="px-4 py-3">Date</th>
                <th class="px-4 py-3">Status</th>
                <th class="px-4 py-3">Photo</th>
                <th class="px-4 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="reports-tbody" class="divide-y divide-gray-100">
              <tr><td colspan="9" class="px-4 py-12 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading reports...</td></tr>
            </tbody>
          </table>
        </div>
        <!-- Pagination info -->
        <div class="px-4 py-3 border-t border-gray-100 text-xs text-gray-500" id="pagination-info">
          Showing 0 reports
        </div>
      </div>

      <!-- Mailing List Section -->
      <div class="bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden mt-6">
        <div class="px-4 py-3 bg-blue-50 border-b border-blue-100 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-envelope text-blue-600"></i>
            <h3 class="text-sm font-bold text-blue-900">Mailing List Subscribers</h3>
            <span id="stat-subscribers" class="ml-2 px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">-</span>
          </div>
          <button onclick="exportMailingListCSV()" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-white text-blue-700 border border-blue-200 hover:bg-blue-50 transition-colors">
            <i class="fa-solid fa-download"></i> Export CSV
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
              <tr>
                <th class="px-4 py-3">Email</th>
                <th class="px-4 py-3">Name</th>
                <th class="px-4 py-3">Subscribed</th>
                <th class="px-4 py-3">Source</th>
              </tr>
            </thead>
            <tbody id="subscribers-tbody" class="divide-y divide-gray-100">
              <tr><td colspan="4" class="px-4 py-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox-overlay" onclick="closeLightbox(event)">
    <button class="lightbox-close" onclick="closeLightbox(event)"><i class="fa-solid fa-xmark"></i></button>
    <img id="lightbox-img" src="" alt="Photo">
  </div>

  <!-- Street View modal -->
  <div id="streetview-modal" class="hidden fixed inset-0 z-[9997] flex items-center justify-center bg-black/60" onclick="if(event.target===this)closeStreetView()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 bg-slate-900">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-street-view text-blue-400"></i>
          <span id="streetview-title" class="text-sm font-medium text-white">Street View</span>
        </div>
        <button onclick="closeStreetView()" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="streetview-container" class="w-full" style="height:500px;">
        <iframe id="streetview-iframe" class="w-full h-full border-0" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </div>

  <!-- Confirm dialog -->
  <div id="confirm-dialog" class="hidden fixed inset-0 z-[9998] flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm mx-4">
      <h3 id="confirm-title" class="text-lg font-bold text-gray-900 mb-2">Confirm</h3>
      <p id="confirm-message" class="text-sm text-gray-600 mb-6"></p>
      <div class="flex gap-3 justify-end">
        <button onclick="confirmCancel()" class="px-4 py-2 text-sm font-medium rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
        <button id="confirm-action-btn" class="px-4 py-2 text-sm font-medium rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">Delete</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[9999] px-4 py-2.5 bg-slate-900 text-white text-sm rounded-lg shadow-lg transition-all duration-300 opacity-0 translate-y-4 pointer-events-none"></div>

<script>
// ============================================
// INIT
// ============================================
const config = window.APP_CONFIG || {};
firebase.initializeApp(config.FIREBASE_CONFIG || {});
const db = firebase.firestore();
const auth = firebase.auth();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

let allReports = [];
let currentFilter = 'all';
let confirmResolve = null;
const photoMap = {};

// ============================================
// AUTH
// ============================================
auth.onAuthStateChanged(async (user) => {
  hideAll();

  if (!user) {
    show('login-gate');
    return;
  }

  show('loading-state');

  try {
    const userDoc = await db.collection('users').doc(user.uid).get();
    const role = userDoc.exists ? (userDoc.data().role || '') : '';
    const isAdmin = (role === 'admin' || role === 'moderator');

    if (!isAdmin) {
      hideAll();
      show('access-denied');
      return;
    }

    document.getElementById('user-info').textContent = user.email || user.displayName || '';
    document.getElementById('user-info').classList.remove('hidden');
    document.getElementById('sign-out-btn').classList.remove('hidden');

    hideAll();
    show('admin-panel');
    loadReports();
    loadSubscribers();
  } catch (err) {
    console.error('Auth check error:', err);
    hideAll();
    show('access-denied');
  }
});

function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hideAll() {
  ['login-gate', 'access-denied', 'loading-state', 'admin-panel'].forEach(id =>
    document.getElementById(id).classList.add('hidden')
  );
}

async function signInWithApple() {
  try {
    const provider = new firebase.auth.OAuthProvider('apple.com');
    provider.addScope('email');
    provider.addScope('name');
    await auth.signInWithPopup(provider);
  } catch (e) {
    document.getElementById('login-error').textContent = e.message;
  }
}

async function signInWithGoogle() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  } catch (e) {
    document.getElementById('login-error').textContent = e.message;
  }
}

async function signInWithEmail() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  if (!email || !password) {
    document.getElementById('login-error').textContent = 'Please enter email and password';
    return;
  }
  try {
    await auth.signInWithEmailAndPassword(email, password);
  } catch (e) {
    document.getElementById('login-error').textContent = e.message;
  }
}

async function signOut() {
  await auth.signOut();
  document.getElementById('user-info').classList.add('hidden');
  document.getElementById('sign-out-btn').classList.add('hidden');
}

// ============================================
// DATA LOADING
// ============================================
async function loadReports() {
  try {
    const [incSnap, annSnap] = await Promise.all([
      db.collection('incidents').orderBy('reportedAt', 'desc').get(),
      db.collection('annoyances').orderBy('reportedAt', 'desc').get()
    ]);

    allReports = [];

    incSnap.forEach(doc => {
      const d = doc.data();
      allReports.push({
        id: doc.id,
        collection: 'incidents',
        type: formatIncidentType(d.incidentType),
        subtype: d.incidentType || '',
        location: d.roadName || '',
        description: d.description || '',
        reporterName: d.reporterName || 'Anonymous',
        reporterEmail: d.contactEmail || '',
        reportedBy: d.reportedBy || '',
        date: d.reportedAt ? d.reportedAt.toDate() : null,
        status: d.status || 'approved',
        verified: d.verified || false,
        flagged: d.flagged || false,
        reportCount: d.reportCount || 0,
        photoURLs: parsePhotos(d),
        coords: d.geometry && d.geometry.coordinates ? d.geometry.coordinates : null,
        scariness: d.scariness || '',
        raw: d
      });
    });

    annSnap.forEach(doc => {
      const d = doc.data();
      allReports.push({
        id: doc.id,
        collection: 'annoyances',
        type: formatAnnoyanceType(d.annoyanceType),
        subtype: d.annoyanceType || '',
        location: d.roadName || '',
        description: d.description || '',
        reporterName: d.reporterName || 'Anonymous',
        reporterEmail: d.contactEmail || '',
        reportedBy: d.reportedBy || '',
        date: d.reportedAt ? d.reportedAt.toDate() : null,
        status: d.status || 'approved',
        verified: d.verified || false,
        flagged: d.flagged || false,
        reportCount: d.reportCount || 0,
        photoURLs: parsePhotos(d),
        coords: d.geometry && d.geometry.coordinates ? d.geometry.coordinates : null,
        raw: d
      });
    });

    updateStats();
    applyFilters();
  } catch (err) {
    console.error('Failed to load reports:', err);
    document.getElementById('reports-tbody').innerHTML =
      '<tr><td colspan="9" class="px-4 py-12 text-center text-red-500">Failed to load reports. Check console.</td></tr>';
  }
}

function parsePhotos(d) {
  if (d.photoURLs && Array.isArray(d.photoURLs)) return d.photoURLs;
  if (d.photoURL) return [d.photoURL];
  if (typeof d.photoURLs === 'string') {
    try { return JSON.parse(d.photoURLs); } catch (e) { return [d.photoURLs]; }
  }
  return [];
}

// ============================================
// STATS
// ============================================
function updateStats() {
  document.getElementById('stat-total').textContent = allReports.length;
  document.getElementById('stat-flagged').textContent = allReports.filter(r => r.flagged).length;
  document.getElementById('stat-pending').textContent = allReports.filter(r => r.status === 'pending_verification').length;
  document.getElementById('stat-approved').textContent = allReports.filter(r => r.status === 'approved').length;
}

// ============================================
// FILTERING & RENDERING
// ============================================
function setFilter(filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-tab').forEach(btn => {
    const active = btn.dataset.filter === filter;
    btn.classList.toggle('bg-white', active);
    btn.classList.toggle('shadow-sm', active);
    btn.classList.toggle('text-gray-900', active);
    btn.classList.toggle('text-gray-500', !active);
  });
  applyFilters();
}

function applyFilters() {
  const search = (document.getElementById('search-input').value || '').toLowerCase();
  const collFilter = document.getElementById('collection-filter').value;

  let filtered = allReports.filter(r => {
    if (currentFilter === 'flagged' && !r.flagged) return false;
    if (currentFilter === 'pending' && r.status !== 'pending_verification') return false;
    if (currentFilter === 'approved' && r.status !== 'approved') return false;
    if (collFilter !== 'all' && r.collection !== collFilter) return false;
    if (search) {
      const haystack = [r.description, r.location, r.reporterName, r.reporterEmail, r.subtype].join(' ').toLowerCase();
      if (!haystack.includes(search)) return false;
    }
    return true;
  });

  // Sort: flagged first, then newest
  filtered.sort((a, b) => {
    if (a.flagged !== b.flagged) return a.flagged ? -1 : 1;
    if (!a.date && !b.date) return 0;
    if (!a.date) return 1;
    if (!b.date) return -1;
    return b.date - a.date;
  });

  renderTable(filtered);
  document.getElementById('pagination-info').textContent = `Showing ${filtered.length} of ${allReports.length} reports`;
}

function renderTable(reports) {
  const tbody = document.getElementById('reports-tbody');

  if (reports.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-12 text-center text-gray-400">No reports match your filters</td></tr>';
    return;
  }

  tbody.innerHTML = reports.map(r => {
    const isIncident = r.collection === 'incidents';
    const collBadge = isIncident
      ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-red-50 text-red-700 border border-red-100"><i class="fa-solid fa-triangle-exclamation mr-1"></i>Incident</span>'
      : '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-amber-50 text-amber-700 border border-amber-100"><i class="fa-solid fa-face-rolling-eyes mr-1"></i>Annoyance</span>';

    const flagBadge = r.flagged
      ? `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-red-100 text-red-700" title="Flagged ${r.reportCount} time(s)"><i class="fa-solid fa-flag mr-0.5"></i>${r.reportCount}</span>`
      : '';

    const statusBadge = getStatusBadge(r.status);

    const desc = r.description.length > 120
      ? `<span class="desc-short">${escapeHtml(r.description.slice(0, 120))}... <button onclick="this.parentElement.classList.add('hidden');this.parentElement.nextElementSibling.classList.remove('hidden')" class="text-blue-600 hover:underline text-[10px]">more</button></span><span class="desc-full hidden">${escapeHtml(r.description)} <button onclick="this.parentElement.classList.add('hidden');this.parentElement.previousElementSibling.classList.remove('hidden')" class="text-blue-600 hover:underline text-[10px]">less</button></span>`
      : escapeHtml(r.description);

    const dateStr = r.date ? r.date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';

    const photoId = r.collection + '_' + r.id;
    if (r.photoURLs.length > 0) photoMap[photoId] = r.photoURLs;
    const photo = r.photoURLs.length > 0
      ? `<img src="${r.photoURLs[0]}" class="w-10 h-10 rounded object-cover cursor-pointer hover:opacity-80 transition-opacity" onclick="openLightbox(photoMap['${photoId}'])" onerror="this.style.display='none'">`
      : '<span class="text-gray-300 text-xs">-</span>';

    const approveBtn = r.status === 'pending_verification'
      ? `<button onclick="approveReport('${r.collection}','${r.id}')" class="inline-flex items-center gap-1 px-2 py-1 text-[11px] font-medium rounded bg-green-50 text-green-700 hover:bg-green-100 border border-green-200 transition-colors"><i class="fa-solid fa-check"></i>Approve</button>`
      : '';

    const unflagBtn = r.flagged
      ? `<button onclick="unflagReport('${r.collection}','${r.id}')" class="inline-flex items-center gap-1 px-2 py-1 text-[11px] font-medium rounded bg-gray-50 text-gray-600 hover:bg-gray-100 border border-gray-200 transition-colors"><i class="fa-solid fa-flag-checkered"></i>Unflag</button>`
      : '';

    const streetViewBtn = r.coords
      ? `<button onclick="openStreetView(${r.coords[1]},${r.coords[0]},'${escapeHtml(r.location || 'Report Location')}')" class="inline-flex items-center gap-1 px-2 py-1 text-[11px] font-medium rounded bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 transition-colors"><i class="fa-solid fa-street-view"></i>View</button>`
      : '';

    const deleteBtn = `<button onclick="deleteReport('${r.collection}','${r.id}')" class="inline-flex items-center gap-1 px-2 py-1 text-[11px] font-medium rounded bg-red-50 text-red-700 hover:bg-red-100 border border-red-200 transition-colors"><i class="fa-solid fa-trash"></i>Delete</button>`;

    const reporterInfo = r.reporterEmail
      ? `<div class="text-xs text-gray-900">${escapeHtml(r.reporterName)}</div><div class="text-[10px] text-gray-400">${escapeHtml(r.reporterEmail)}</div>`
      : `<div class="text-xs text-gray-900">${escapeHtml(r.reporterName)}</div>`;

    return `<tr class="hover:bg-gray-50 ${r.flagged ? 'bg-red-50/50' : ''}" data-id="${r.id}">
      <td class="px-4 py-3">${flagBadge}</td>
      <td class="px-4 py-3"><div class="space-y-1">${collBadge}<div class="text-[11px] text-gray-500 mt-0.5">${escapeHtml(r.type)}</div></div></td>
      <td class="px-4 py-3 text-xs text-gray-700">${escapeHtml(r.location || '-')}</td>
      <td class="px-4 py-3 text-xs text-gray-700 max-w-xs">${desc}</td>
      <td class="px-4 py-3">${reporterInfo}</td>
      <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${dateStr}</td>
      <td class="px-4 py-3">${statusBadge}</td>
      <td class="px-4 py-3">${photo}</td>
      <td class="px-4 py-3 text-right"><div class="flex gap-1.5 justify-end">${streetViewBtn}${approveBtn}${unflagBtn}${deleteBtn}</div></td>
    </tr>`;
  }).join('');
}

function getStatusBadge(status) {
  switch (status) {
    case 'approved':
      return '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-green-50 text-green-700 border border-green-100">Approved</span>';
    case 'pending_verification':
      return '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-amber-50 text-amber-700 border border-amber-100">Pending</span>';
    default:
      return `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-gray-50 text-gray-600 border border-gray-100">${escapeHtml(status)}</span>`;
  }
}

// ============================================
// ACTIONS
// ============================================
async function approveReport(collection, docId) {
  try {
    await db.collection(collection).doc(docId).update({
      status: 'approved',
      verified: true
    });

    const report = allReports.find(r => r.id === docId && r.collection === collection);
    if (report) {
      report.status = 'approved';
      report.verified = true;
    }

    updateStats();
    applyFilters();
    showToast('Report approved');
  } catch (err) {
    console.error('Approve failed:', err);
    showToast('Failed to approve report');
  }
}

async function unflagReport(collection, docId) {
  try {
    await db.collection(collection).doc(docId).update({
      flagged: false,
      reportCount: 0
    });

    const report = allReports.find(r => r.id === docId && r.collection === collection);
    if (report) {
      report.flagged = false;
      report.reportCount = 0;
    }

    updateStats();
    applyFilters();
    showToast('Report unflagged');
  } catch (err) {
    console.error('Unflag failed:', err);
    showToast('Failed to unflag report');
  }
}

async function deleteReport(collection, docId) {
  const ok = await showConfirm('Delete Report', 'Are you sure you want to permanently delete this report? This cannot be undone.');
  if (!ok) return;

  try {
    await db.collection(collection).doc(docId).delete();

    allReports = allReports.filter(r => !(r.id === docId && r.collection === collection));

    // Remove row with animation
    const row = document.querySelector(`tr[data-id="${docId}"]`);
    if (row) {
      row.style.transition = 'opacity 0.3s, transform 0.3s';
      row.style.opacity = '0';
      row.style.transform = 'translateX(20px)';
      setTimeout(() => { row.remove(); }, 300);
    }

    updateStats();
    setTimeout(() => applyFilters(), 350);
    showToast('Report deleted');
  } catch (err) {
    console.error('Delete failed:', err);
    showToast('Failed to delete report');
  }
}

// ============================================
// CONFIRM DIALOG
// ============================================
function showConfirm(title, message) {
  return new Promise(resolve => {
    confirmResolve = resolve;
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-action-btn').onclick = () => {
      document.getElementById('confirm-dialog').classList.add('hidden');
      resolve(true);
    };
    document.getElementById('confirm-dialog').classList.remove('hidden');
  });
}

function confirmCancel() {
  document.getElementById('confirm-dialog').classList.add('hidden');
  if (confirmResolve) {
    confirmResolve(false);
    confirmResolve = null;
  }
}

// ============================================
// LIGHTBOX
// ============================================
function openLightbox(urls) {
  const overlay = document.getElementById('lightbox');
  document.getElementById('lightbox-img').src = Array.isArray(urls) ? urls[0] : urls;
  overlay.classList.add('active');
}

function closeLightbox(e) {
  if (e && e.target !== e.currentTarget && !e.target.closest('.lightbox-close')) return;
  document.getElementById('lightbox').classList.remove('active');
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeLightbox({ target: document.getElementById('lightbox'), currentTarget: document.getElementById('lightbox') });
    closeStreetView();
    confirmCancel();
  }
});

// ============================================
// STREET VIEW
// ============================================
function openStreetView(lat, lng, title) {
  const key = (config.GOOGLE_PLACES_KEY || '');
  document.getElementById('streetview-title').textContent = title || 'Street View';
  const iframe = document.getElementById('streetview-iframe');
  iframe.src = `https://www.google.com/maps/embed/v1/streetview?key=${key}&location=${lat},${lng}&heading=0&pitch=0&fov=90`;
  document.getElementById('streetview-modal').classList.remove('hidden');
}

function closeStreetView() {
  document.getElementById('streetview-modal').classList.add('hidden');
  document.getElementById('streetview-iframe').src = '';
}

// ============================================
// HELPERS
// ============================================
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatIncidentType(type) {
  if (!type) return 'Unknown';
  return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatAnnoyanceType(type) {
  if (!type) return 'Unknown';
  return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
  toast.classList.add('opacity-100', 'translate-y-0');
  setTimeout(() => {
    toast.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
    toast.classList.remove('opacity-100', 'translate-y-0');
  }, 3000);
}

// ============================================
// MAILING LIST
// ============================================
let allSubscribers = [];

async function loadSubscribers() {
  try {
    const snap = await db.collection('mailingList').orderBy('subscribedAt', 'desc').get();
    allSubscribers = [];
    snap.forEach(doc => allSubscribers.push({ id: doc.id, ...doc.data() }));
    document.getElementById('stat-subscribers').textContent = allSubscribers.length;
    document.getElementById('stat-subscribers-card').textContent = allSubscribers.length;
    renderSubscribers();
  } catch (e) {
    console.error('Error loading subscribers:', e);
    document.getElementById('subscribers-tbody').innerHTML =
      '<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">Failed to load subscribers</td></tr>';
  }
}

function renderSubscribers() {
  const tbody = document.getElementById('subscribers-tbody');
  if (allSubscribers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400">No subscribers yet</td></tr>';
    return;
  }
  tbody.innerHTML = allSubscribers.map(s => {
    const date = s.subscribedAt ? s.subscribedAt.toDate().toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
    const sourceBadge = s.source === 'incident'
      ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-red-50 text-red-700 border border-red-100">Incident</span>'
      : '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-amber-50 text-amber-700 border border-amber-100">Annoyance</span>';
    return `<tr class="hover:bg-gray-50">
      <td class="px-4 py-3 text-xs text-gray-900 font-medium">${escapeHtml(s.email || '-')}</td>
      <td class="px-4 py-3 text-xs text-gray-700">${escapeHtml(s.name || '-')}</td>
      <td class="px-4 py-3 text-xs text-gray-500">${date}</td>
      <td class="px-4 py-3">${sourceBadge}</td>
    </tr>`;
  }).join('');
}

function exportMailingListCSV() {
  if (allSubscribers.length === 0) { showToast('No subscribers to export'); return; }
  const header = 'Email,Name,Subscribed Date,Source\n';
  const rows = allSubscribers.map(s => {
    const date = s.subscribedAt ? s.subscribedAt.toDate().toISOString().split('T')[0] : '';
    return [csvEscape(s.email || ''), csvEscape(s.name || ''), date, s.source || ''].join(',');
  }).join('\n');
  const blob = new Blob([header + rows], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'nearmissmap-mailing-list-' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function csvEscape(str) {
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}
</script>

</body>
</html>
