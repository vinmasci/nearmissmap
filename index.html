<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Near Miss Map</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} },
      plugins: [
        function({ addVariant }) {
          addVariant('hs-overlay-open', '.open&, .open &');
        }
      ],
    }
  </script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Config -->
  <script src="config.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="nearmissmap.css">
</head>
<body class="font-['Inter',sans-serif]">
  <!-- Navbar -->
  <header id="nmm-navbar" class="sticky top-0 z-[9999] flex flex-wrap md:justify-start md:flex-nowrap w-full bg-white border-b border-gray-200 shadow-sm" style="font-family: 'DM Sans', sans-serif;">
    <nav class="w-full mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-x-2.5">
          <div class="size-9 rounded-lg bg-red-600 flex items-center justify-center">
            <i class="fa-solid fa-triangle-exclamation text-white text-lg"></i>
          </div>
          <div class="leading-tight">
            <span class="text-lg font-bold text-gray-800">Near Miss Map</span>
            <span class="block text-[11px] text-gray-400 -mt-0.5">Report cycling incidents & annoyances</span>
          </div>
        </div>
        <a href="https://vicbug.app" target="_blank" class="text-xs text-gray-400 hover:text-blue-600 transition-colors">
          Powered by VicBUG
        </a>
      </div>
    </nav>
  </header>

  <!-- Map -->
  <div id="map"></div>

  <!-- Top bar: Search + Filters -->
  <div class="fixed top-[68px] left-2 right-2 z-[150] flex flex-col gap-2 md:flex-row md:items-center md:left-3 md:right-3">
    <!-- Search row -->
    <div class="flex gap-2 items-center">
      <div class="flex-1 min-w-0 relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="search-input" placeholder="Search location..." class="w-full h-10 pl-9 pr-3 bg-white border border-gray-200 rounded-xl shadow-md text-sm text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-blue-500 focus:ring-2 focus:outline-none">
      </div>
      <button id="locate-btn" title="My location" class="shrink-0 w-10 h-10 inline-flex items-center justify-center bg-white rounded-xl shadow-md border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-300 transition-colors">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
      </button>
      <button id="reset-view-btn" title="Reset view" class="shrink-0 w-10 h-10 inline-flex items-center justify-center bg-white rounded-xl shadow-md border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-300 transition-colors md:hidden">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
      </button>
    </div>
    <!-- Filter row -->
    <div id="filter-bar" class="flex flex-nowrap items-center gap-1.5 bg-white/95 backdrop-blur-sm py-1.5 px-2.5 rounded-xl shadow-md overflow-x-auto text-xs md:py-2 md:px-3 [-webkit-overflow-scrolling:touch] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
      <select id="filter-report-type" class="shrink-0 py-1.5 px-2 pe-7 border-gray-200 rounded-lg text-xs focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none bg-white">
        <option value="">All Reports</option>
        <option value="incident">Incidents</option>
        <option value="annoyance">Annoyances</option>
      </select>
      <select id="filter-type" class="shrink-0 py-1.5 px-2 pe-7 border-gray-200 rounded-lg text-xs focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none bg-white">
        <option value="">All Types</option>
        <option value="intersection">Intersection</option>
        <option value="same_direction">Sideswipe / Rear End</option>
        <option value="driveway_uturn">Driveway / U-Turn</option>
        <option value="dooring">Dooring</option>
        <option value="loss_of_control">Loss of Control</option>
        <option value="hit_parked">Hit Parked Car</option>
        <option value="parking">Parking Manoeuvre</option>
        <option value="head_on">Head-On</option>
        <option value="pedestrian">Pedestrian</option>
        <option value="overtaking">Close Pass</option>
        <option value="struck_object">Struck Object / Animal</option>
        <option value="road_rage">Road Rage</option>
        <option value="other">Other</option>
      </select>
      <select id="filter-scariness" class="shrink-0 py-1.5 px-2 pe-7 border-gray-200 rounded-lg text-xs focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none bg-white">
        <option value="">All Scariness</option>
        <option value="not_scary">Not Scary</option>
        <option value="a_bit_scary">A Bit Scary</option>
        <option value="fairly_scary">Fairly Scary</option>
        <option value="very_scary">Very Scary</option>
      </select>
      <button id="filter-reset" class="shrink-0 py-1.5 px-2.5 inline-flex items-center gap-x-1 text-xs font-medium rounded-lg border border-gray-200 bg-white text-gray-500 shadow-sm hover:bg-gray-50 whitespace-nowrap disabled:opacity-50 disabled:pointer-events-none">Reset</button>
      <span id="incident-count" class="shrink-0 ml-auto text-[11px] font-semibold text-gray-500 whitespace-nowrap">0</span>
    </div>
  </div>


  <!-- Report buttons (floating) -->
  <div id="report-buttons" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[160] flex gap-2 max-md:bottom-6">
    <button id="report-btn" data-mode="incident" class="py-3 px-5 inline-flex items-center gap-x-2 text-sm font-medium rounded-full border border-transparent bg-red-600 text-white shadow-lg shadow-red-600/40 hover:bg-red-700 focus:outline-none focus:bg-red-700 transition-all">
      <i class="fa-solid fa-triangle-exclamation"></i> Report Incident
    </button>
    <button id="report-annoying-btn" data-mode="annoyance" class="py-3 px-5 inline-flex items-center gap-x-2 text-sm font-medium rounded-full border border-transparent bg-amber-500 text-white shadow-lg shadow-amber-500/40 hover:bg-amber-600 focus:outline-none focus:bg-amber-600 transition-all">
      <i class="fa-solid fa-face-rolling-eyes"></i> Report Annoying
    </button>
  </div>

  <!-- Incident Report Panel -->
  <div id="incident-panel" class="incident-panel">
    <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 shrink-0">
      <h2 class="text-lg font-bold text-gray-800">Report Incident</h2>
      <button id="panel-close" class="size-8 inline-flex justify-center items-center rounded-lg text-gray-400 hover:text-gray-500 hover:bg-gray-100 transition-all">
        <svg class="size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto p-5 space-y-5">
      <!-- Location -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Location</label>
        <div id="incident-location" class="flex items-center gap-2 py-2.5 px-3 bg-gray-50 rounded-lg text-[13px] text-gray-700">
          <svg class="w-4 h-4 text-gray-400 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/></svg>
          <span>Click the map to set location</span>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Infrastructure (auto-detected from OSM) -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">
          <i class="fa-solid fa-road text-gray-400 mr-1"></i> Road / Path Info
          <span id="infra-spinner" class="hidden ml-1 inline-block w-3 h-3 border-2 border-gray-300 border-t-blue-500 rounded-full" style="animation:spin .6s linear infinite"></span>
        </label>
        <div id="infrastructure-card" class="py-2.5 px-3 bg-gray-50 rounded-lg min-h-[36px]">
          <span class="text-xs text-gray-400">Drop a pin to auto-detect road details</span>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Incident Type (13 DCA-based categories) -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Type of Incident</label>
        <div class="grid grid-cols-2 gap-2" id="type-grid">
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="intersection">
            <i class="fa-solid fa-shuffle w-[18px] text-center shrink-0"></i> Intersection
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="same_direction">
            <i class="fa-solid fa-car-rear w-[18px] text-center shrink-0"></i> Sideswipe / Rear End
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="driveway_uturn">
            <i class="fa-solid fa-rotate-left w-[18px] text-center shrink-0"></i> Driveway / U-Turn
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="dooring">
            <i class="fa-solid fa-door-open w-[18px] text-center shrink-0"></i> Dooring
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="loss_of_control">
            <i class="fa-solid fa-person-falling w-[18px] text-center shrink-0"></i> Loss of Control
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="hit_parked">
            <i class="fa-solid fa-square-parking w-[18px] text-center shrink-0"></i> Hit Parked Car
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="parking">
            <i class="fa-solid fa-car-side w-[18px] text-center shrink-0"></i> Parking Manoeuvre
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="head_on">
            <i class="fa-solid fa-car-burst w-[18px] text-center shrink-0"></i> Head-On
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="pedestrian">
            <i class="fa-solid fa-person-walking w-[18px] text-center shrink-0"></i> Pedestrian
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="overtaking">
            <i class="fa-solid fa-angles-right w-[18px] text-center shrink-0"></i> Close Pass
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="struck_object">
            <i class="fa-solid fa-triangle-exclamation w-[18px] text-center shrink-0"></i> Object / Animal
          </button>
          <button class="type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="road_rage">
            <i class="fa-solid fa-face-angry w-[18px] text-center shrink-0"></i> Road Rage
          </button>
          <button class="type-btn col-span-2 inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="other">
            <i class="fa-solid fa-circle-question w-[18px] text-center shrink-0"></i> Other
          </button>
        </div>
        <p id="type-description" class="mt-2 text-xs text-gray-500 leading-relaxed hidden"></p>
      </div>

      <hr class="border-gray-100">

      <!-- How Scary Was It? -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">How scary was it?</label>
        <div class="grid grid-cols-2 gap-2">
          <button class="scariness-btn py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-scariness="not_scary">Not Scary</button>
          <button class="scariness-btn py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-scariness="a_bit_scary">A Bit Scary</button>
          <button class="scariness-btn py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-scariness="fairly_scary">Fairly Scary</button>
          <button class="scariness-btn py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-scariness="very_scary">Very Scary</button>
        </div>
        <p id="scariness-description" class="mt-2 text-xs text-gray-500 leading-relaxed hidden"></p>
      </div>

      <hr class="border-gray-100">

      <!-- Contact Made? -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Was there contact / collision?</label>
        <div class="flex gap-2">
          <button class="contact-btn flex-1 py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-contact="no">No (near miss)</button>
          <button class="contact-btn flex-1 py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-contact="yes">Yes (contact made)</button>
        </div>
      </div>

      <!-- Any Injury? -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Any injury?</label>
        <div class="flex gap-2">
          <button class="injury-btn flex-1 py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-injury="no">No</button>
          <button class="injury-btn flex-1 py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-injury="yes">Yes</button>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Other Party -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Other Party Involved</label>
        <div class="flex flex-wrap gap-1.5" id="party-grid">
          <button class="party-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-party="motor_vehicle">Motor Vehicle</button>
          <button class="party-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-party="pedestrian">Pedestrian</button>
          <button class="party-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-party="cyclist">Cyclist</button>
          <button class="party-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-party="e_scooter">E-scooter</button>
          <button class="party-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-party="animal">Animal</button>
          <button class="party-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-party="none">None</button>
          <button class="party-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-party="other">Other</button>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Date/Time -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">When did it happen?</label>
        <div class="grid grid-cols-2 gap-2">
          <input type="date" id="incident-date" class="py-2.5 px-3 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
          <input type="time" id="incident-time" class="py-2.5 px-3 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Conditions -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Conditions</label>
        <div class="grid grid-cols-2 gap-2 mb-2">
          <select id="incident-lighting" class="py-2.5 px-3 pe-7 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
            <option value="">Lighting...</option>
            <option value="daylight">Daylight</option>
            <option value="dawn_dusk">Dawn/Dusk</option>
            <option value="dark_lit">Dark (street lit)</option>
            <option value="dark_unlit">Dark (unlit)</option>
          </select>
          <select id="incident-weather" class="py-2.5 px-3 pe-7 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
            <option value="">Weather...</option>
            <option value="clear">Clear</option>
            <option value="cloudy">Cloudy</option>
            <option value="rain">Rain</option>
            <option value="fog">Fog</option>
            <option value="wind">Strong Wind</option>
          </select>
        </div>
        <select id="incident-surface" class="py-2.5 px-3 pe-7 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
          <option value="">Road Surface...</option>
          <option value="dry">Dry</option>
          <option value="wet">Wet</option>
          <option value="gravel">Gravel/Loose</option>
          <option value="ice">Ice/Frost</option>
        </select>
      </div>

      <hr class="border-gray-100">

      <!-- About the Rider -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">About the Rider</label>
        <div id="rider-fields" class="space-y-3">
          <div>
            <label class="block text-[11px] text-gray-400 mb-1">Reporting for</label>
            <div class="flex flex-wrap gap-1.5" id="reporter-grid">
              <button class="reporter-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-reporter="myself">Myself</button>
              <button class="reporter-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-reporter="my_child">My Child</button>
              <button class="reporter-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-reporter="witnessed">Someone I Witnessed</button>
              <button class="reporter-btn py-1.5 px-3 text-xs font-medium text-gray-700 border border-gray-200 rounded-full hover:border-gray-300 transition-colors" data-reporter="other">Other</button>
            </div>
          </div>
          <div>
            <label class="block text-[11px] text-gray-400 mb-1">Rider age range</label>
            <select id="rider-age" class="py-2 px-3 pe-7 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
              <option value="">Select...</option>
              <option value="under_18">Under 18</option>
              <option value="18_25">18–25</option>
              <option value="26_35">26–35</option>
              <option value="36_45">36–45</option>
              <option value="46_55">46–55</option>
              <option value="56_65">56–65</option>
              <option value="65_plus">65+</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] text-gray-400 mb-1">Ride type</label>
              <select id="ride-type" class="py-2 px-3 pe-7 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
                <option value="">Select...</option>
                <option value="commute">Commute</option>
                <option value="road_ride">Road Ride</option>
                <option value="gravel_ride">Gravel Ride</option>
                <option value="mtb">Mountain Bike</option>
                <option value="touring">Touring</option>
                <option value="ebike_ride">E-bike Ride</option>
                <option value="leisure">Leisure / Recreation</option>
              </select>
            </div>
            <div>
              <label class="block text-[11px] text-gray-400 mb-1">Bike type</label>
              <select id="bike-type" class="py-2 px-3 pe-7 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
                <option value="">Select...</option>
                <option value="road">Road Bike</option>
                <option value="mountain">Mountain Bike</option>
                <option value="gravel">Gravel Bike</option>
                <option value="ebike">E-bike</option>
                <option value="cargo">Cargo Bike</option>
                <option value="folding">Folding Bike</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Description -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Description <span class="text-red-500">*</span></label>
        <textarea id="incident-description" class="py-2.5 px-3 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 min-h-[80px] resize-y" placeholder="Describe what happened..." maxlength="1000"></textarea>
        <p id="char-count" class="text-[11px] text-gray-400 text-right mt-1">0 / 1000</p>
      </div>
    </div>
    <div class="px-5 py-4 border-t border-gray-200 shrink-0">
      <button id="incident-submit" disabled class="w-full py-3 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:bg-red-700 disabled:opacity-50 disabled:pointer-events-none transition-colors">
        <svg class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4M12 17h.01M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>
        Submit Report
      </button>
    </div>
  </div>

  <!-- Annoyance Report Panel -->
  <div id="annoyance-panel" class="incident-panel">
    <div class="flex items-center justify-between px-5 py-4 border-b border-amber-200 bg-amber-50 shrink-0">
      <h2 class="text-lg font-bold text-amber-900"><i class="fa-solid fa-face-rolling-eyes mr-1"></i> Report Annoying</h2>
      <button id="annoyance-panel-close" class="size-8 inline-flex justify-center items-center rounded-lg text-amber-600 hover:text-amber-700 hover:bg-amber-100 transition-all">
        <svg class="size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto p-5 space-y-5">
      <!-- Location -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Location</label>
        <div id="annoyance-location" class="flex items-center gap-2 py-2.5 px-3 bg-gray-50 rounded-lg text-[13px] text-gray-700">
          <svg class="w-4 h-4 text-gray-400 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/></svg>
          <span>Click the map to set location</span>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Infrastructure (auto-detected) -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">
          <i class="fa-solid fa-road text-gray-400 mr-1"></i> Road / Path Info
          <span id="annoyance-infra-spinner" class="hidden ml-1 inline-block w-3 h-3 border-2 border-gray-300 border-t-amber-500 rounded-full" style="animation:spin .6s linear infinite"></span>
        </label>
        <div id="annoyance-infrastructure-card" class="py-2.5 px-3 bg-gray-50 rounded-lg min-h-[36px]">
          <span class="text-xs text-gray-400">Drop a pin to auto-detect road details</span>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Annoyance Type -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">What's annoying?</label>
        <div class="grid grid-cols-2 gap-2" id="annoyance-type-grid">
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="blocked_lane">
            <i class="fa-solid fa-road-barrier w-[18px] text-center shrink-0"></i> Blocked Bike Lane
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="poor_surface">
            <i class="fa-solid fa-road-circle-exclamation w-[18px] text-center shrink-0"></i> Poor Surface
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="glass_debris">
            <i class="fa-solid fa-burst w-[18px] text-center shrink-0"></i> Glass / Debris
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="overgrown">
            <i class="fa-solid fa-leaf w-[18px] text-center shrink-0"></i> Overgrown
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="faded_markings">
            <i class="fa-solid fa-border-none w-[18px] text-center shrink-0"></i> Faded Markings
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="no_infrastructure">
            <i class="fa-solid fa-ban w-[18px] text-center shrink-0"></i> No Bike Infra
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="poor_signage">
            <i class="fa-solid fa-signs-post w-[18px] text-center shrink-0"></i> Poor Signage
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="traffic_lights">
            <i class="fa-solid fa-traffic-light w-[18px] text-center shrink-0"></i> Traffic Lights
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="pinch_point">
            <i class="fa-solid fa-right-left w-[18px] text-center shrink-0"></i> Pinch Point
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="poor_lighting">
            <i class="fa-regular fa-lightbulb w-[18px] text-center shrink-0"></i> Poor Lighting
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="path_ends">
            <i class="fa-solid fa-road-circle-xmark w-[18px] text-center shrink-0"></i> Path Ends
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="dog_off_leash">
            <i class="fa-solid fa-dog w-[18px] text-center shrink-0"></i> Dog Off Leash
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="bad_intersection">
            <i class="fa-solid fa-diamond-turn-right w-[18px] text-center shrink-0"></i> Bad Intersection
          </button>
          <button class="annoyance-type-btn inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="flooding">
            <i class="fa-solid fa-water w-[18px] text-center shrink-0"></i> Flooding
          </button>
          <button class="annoyance-type-btn col-span-2 inline-flex items-center gap-2 py-2.5 px-3 text-[13px] font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-type="other">
            <i class="fa-solid fa-circle-question w-[18px] text-center shrink-0"></i> Other
          </button>
        </div>
        <p id="annoyance-type-description" class="mt-2 text-xs text-gray-500 leading-relaxed hidden"></p>
      </div>

      <hr class="border-gray-100">

      <!-- Ongoing or one-off? -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Is this ongoing?</label>
        <div class="flex gap-2">
          <button class="ongoing-btn flex-1 py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-ongoing="yes">Ongoing issue</button>
          <button class="ongoing-btn flex-1 py-2 px-2 text-xs font-medium text-center text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-ongoing="no">One-off</button>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Date/Time -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">When did you notice it?</label>
        <div class="grid grid-cols-2 gap-2">
          <input type="date" id="annoyance-date" class="py-2.5 px-3 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
          <input type="time" id="annoyance-time" class="py-2.5 px-3 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Description -->
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Description <span class="text-red-500">*</span></label>
        <textarea id="annoyance-description" class="py-2.5 px-3 block w-full border-gray-200 rounded-lg text-[13px] focus:border-blue-500 focus:ring-blue-500 min-h-[80px] resize-y" placeholder="Describe what's annoying..." maxlength="1000"></textarea>
        <p id="annoyance-char-count" class="text-[11px] text-gray-400 text-right mt-1">0 / 1000</p>
      </div>
    </div>
    <div class="px-5 py-4 border-t border-gray-200 shrink-0">
      <button id="annoyance-submit" disabled class="w-full py-3 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-amber-500 text-white hover:bg-amber-600 focus:outline-none focus:bg-amber-600 disabled:opacity-50 disabled:pointer-events-none transition-colors">
        <i class="fa-solid fa-face-rolling-eyes"></i> Submit Report
      </button>
    </div>
  </div>

  <!-- Login Modal (Preline hs-overlay) -->
  <div id="login-modal" class="hs-overlay hidden size-full fixed top-0 start-0 z-[2000] overflow-x-hidden overflow-y-auto" role="dialog" tabindex="-1">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-md sm:w-full m-3 sm:mx-auto min-h-[calc(100%-3.5rem)] flex items-center">
      <div class="w-full flex flex-col bg-white border border-gray-200 shadow-2xl rounded-2xl">
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
          <div class="text-center flex-1">
            <h3 class="text-lg font-bold text-gray-800">Sign In</h3>
            <p class="text-sm text-gray-500">Sign in to report cycling incidents</p>
          </div>
          <button type="button" class="shrink-0 size-8 inline-flex justify-center items-center rounded-lg text-gray-400 hover:text-gray-500 hover:bg-gray-100 transition-all" onclick="hideLoginModal()">
            <span class="sr-only">Close</span>
            <svg class="size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
          </button>
        </div>
        <div class="p-6">
          <div id="login-options" class="space-y-3">
            <button onclick="signInWithApple()" class="w-full py-3 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-gray-800 text-white hover:bg-gray-900 transition-colors">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
              Continue with Apple
            </button>

            <button onclick="signInWithGoogle()" class="w-full py-3 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 transition-colors">
              <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
              Continue with Google
            </button>

            <div class="py-3 flex items-center text-xs text-gray-400 uppercase before:flex-1 before:border-t before:border-gray-200 before:me-6 after:flex-1 after:border-t after:border-gray-200 after:ms-6">or</div>

            <button onclick="showEmailForm()" class="w-full py-3 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 transition-colors">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              Continue with Email
            </button>
          </div>

          <div id="email-form" class="hidden space-y-3">
            <input type="email" id="login-email" placeholder="Email address" class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
            <input type="password" id="login-password" placeholder="Password" class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
            <button onclick="signInWithEmail()" class="w-full py-3 px-4 inline-flex items-center justify-center text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">Sign In</button>
            <button onclick="showLoginOptions()" class="text-blue-600 text-sm hover:underline mt-2">&larr; Back to options</button>
            <p id="login-error" class="text-red-500 text-sm text-center"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/preline@2.0.3/dist/preline.min.js"></script>
  <script>
    // Load Google Places API dynamically using config key
    (function() {
      const key = (window.APP_CONFIG || {}).GOOGLE_PLACES_KEY;
      if (key) {
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places&callback=initPlacesAutocomplete`;
        s.async = true;
        s.defer = true;
        document.head.appendChild(s);
      }
    })();
  </script>
  <script src="nearmissmap.js"></script>
</body>
</html>
